\documentclass[a4paper, 12pt]{article}		% general format

%%%% Charset
\usepackage{cmap}							% make PDF files searchable and copyable
\usepackage[utf8x]{inputenc}				% accept different input encodings
\usepackage[T2A]{fontenc}					% russian font
\usepackage[russian]{babel}					% multilingual support (T2A)

%%%% Graphics
\usepackage[dvipsnames]{xcolor}			% driver-independent color extensions
\usepackage{graphicx}						% enhanced support for graphics
\usepackage{wrapfig}						% produces figures which text can flow around

%%%% Math
\usepackage{amsmath}						% American Mathematical Society (AMS) math facilities
\usepackage{amsfonts}						% fonts from the AMS
\usepackage{amssymb}						% additional math symbols

%%%% Typograpy (don't forget about cm-super)
\usepackage{microtype}						% subliminal refinements towards typographical perfection
\linespread{1.3}							% line spacing
\usepackage[left=2.5cm, right=1.5cm, top=2.5cm, bottom=2.5cm]{geometry}
\setlength{\parindent}{0pt}					% we don't want any paragraph indentation
\usepackage{parskip}						% some distance between paragraphs

%%%% Tables
\usepackage{tabularx}						% tables with variable width columns
\usepackage{multirow}						% for tabularx
\usepackage{hhline}							% for tabularx

%%%% Graph
\usepackage{tikz}							% package for creating graphics programmatically
\usetikzlibrary{arrows}						% edges for tikz

%%%% Other
\usepackage{url}							% verbatim with URL-sensitive line breaks
\usepackage{fancyvrb}						% sophisticated verbatim text (with box)
%------------------------------------------------------------------------------

\begin{document}

\input{titlepage}
\tableofcontents

%------------------------------------------------------------------------------
\input{intro}

%------------------------------------------------------------------------------
\input{install}

%------------------------------------------------------------------------------
\newpage
\section{Разработка архитектуры ККС}

Рабочий макет стандартной схемы ККС (реализованной в виде многосегментной локальной сети), подключенной к внешней сети (названной для общности Интернет) показан на рисунке 1. Для простоты в каждый сегмент сети помещен только один хост.

\begin{figure}[h!]
\centering
\includegraphics[scale=1]{res/network_general}
\caption{Рабочий макет стандартной схемы ККС.}
\end{figure}

Эмулируемая ККС имеет три сегмента (подсети)\footnote{Адрес подсети должен содержать маску! Далее будем полагать что речь идёт об /24 сетях.}:
\begin{itemize}
\item VMnet1 (адрес подсети – 192.168.40.0)
\item VMnet2 (адрес подсети – 192.168.80.0)
\item VMnet3 (адрес подсети – 192.168.120.0)
\end{itemize}

Сеть VMnet1 содержит основной многофункциональный сервер ККС (службы DHCP, DNS, Web, Proxy, почтовая, файловая и др.), использующий ОС Linux Mandrake. Сеть VMnet2 представлена хостом под управлением ОС Windows 2k (2000/XP/2003 Server) и имеет двойное назначение – она обеспечивает ККС дополнительным сервером и поддерживает Windows-клиент семейства 2k. Сеть VMnet3 объединяет рабочие станции c ограниченными аппаратными ресурсами, ориентированные на ОС Windows семейства 9x (95/98).

Взаимодействие сегментов ККС осуществляет маршрутизатор, обслуживаемый ОС семейства Unix (FreeBSD), а подключение ККС к внешней сети (Интернет или реальной сети учебной лаборатории) обеспечивает шлюз, реализуемый другой ОС семейства Unix (NetBSD).

Естественно, что каждый представитель подсетей (VMnet1, Vmnet2, VMnet3) имеет один сетевой адаптер, шлюз – два, а маршрутизатор – три сетевых адаптера.

Для определённости будем считать, что ККС использует смешанное (и статическое, и динамическое) распределение IP-адресов. 

Хост WIN98 (здесь и далее имя хоста формируется от названия гостевой ОС) имеет статический адрес 192.168.120.15, хост LINUX также имеет статический адрес – 192.168.40.32, а хост WIN2000 получает адрес 192.168.80.128 динамически с помощью виртуального сервера DHCP (встроенного по умолчанию в каждый сегмент сети, эмулируемой в среде VMware Workstation).

\begin{figure}[h!]
\centering
\includegraphics[scale=1]{res/network_general2}
\caption{Стандартная схема ККС.}
\end{figure}

Целесообразно выделить статические адреса для хостов FREEBSD (маршрутизатор) и NETBSD (шлюз). Для простоты адресам всех сетевых адаптеров маршрутизатора назначим одинаковые суффиксы – 192.168.40.2 (для связи с сетью VMnet1), 192.168.80.2 (для связи с сетью VMnet2), 192.168.120.2 (для связи с сетью VMnet3). Функциональное назначение шлюза (обеспечение взаимодействия ККС с внешними сетями) предполагает наличие какого-нибудь механизма сопряжения IP-адресов. Таким механизмом является служба NAT (преобразование сетевых адресов), подключённая к вспомогательной сети VMnet8, в которую (кроме устройства NAT) входит DHCP-сервер и шлюз. Адрес «внешнего» сетевого адаптера шлюза назначается динамически (DHCP-сервером сети VMnet8) – 192.168.32.128, а  адрес «внутреннего» сетевого адаптера шлюза (входящего в сеть VMnet1) статически – 192.168.40.57.

В результате всех подключений имеем схему ККС, представленную на рисунке 2.

%------------------------------------------------------------------------------
\newpage
\section{Эмуляция ККС в среде VirtualBox}

Эмуляция ККС считается завершенной, если выполнены следующие этапы:
\begin{itemize}
\item создание и настройка виртуальных сетей
\item создание и настройка виртуальных хостов
\end{itemize}

\subsection{Создание и настройка виртуальных сетей}

Построим вспомогательную сеть VMnet8 при помощи хост-машины, которая будет через NAT обеспечивать доступ NetBSD к ресурсам сети Интернет.

Для этого в меню File выбираем пункт Preferences, а в открывшемся окне переходим на вкладку Networks (рисунок 3).

\begin{figure}[h!]
\centering
\includegraphics[scale=0.8]{res/virtualbox-networks}
\caption{Настройки сетевой системы VirtualBox.}
\end{figure}

При помощи кнопку со значком "+" добавим новую сетевую карту, которая будет обращена к виртуальной машине, а потом при помощи кнопки с отвёрткой сконфигурируем её так, как показано на рисунке 4.

\begin{figure}[h!]
\centering
\includegraphics[scale=0.8]{res/virtualbox-nat}
\caption{Подготовка вспомогательной сети VMnet8.}
\end{figure}

Теперь создадим виртуальные машины (без установки и настройки) для прокладки виртуальных сетей. Для начала создадим NetBSD, используя стандартный шаблон, предлагаемый VirtualBox. Далее перейдём в сетевые настройки виртуальной машины и настроим первую сетевую карту для работы в режиме NAT через вспомогательную сеть VMnet8, как показано на рисунке 5.

\begin{figure}[h!]
\centering
\includegraphics[scale=0.6]{res/netbsd-nat}
\caption{Настройка сетевого интерфейса NetBSD на работу с сетью VMnet8.}
\end{figure}

После этого можно перейти на вкладку с настройками для адаптера 2, включить его и обеспечить подключение к сети VMnet1 (рисунок 6).

\begin{figure}[h!]
\centering
\includegraphics[scale=0.6]{res/netbsd-vmnet1}
\caption{Настройка второго сетевого интерфейса NetBSD на работу с сетью VMnet1.}
\end{figure}

После этого, пользуясь стандартными шаблонами и некоторыми оптимизациями, создадим ещё 4 виртуальные машины (Linux, FreeBSD, Win2000, Win98) и укажем в настройках их сетевых подключений ту сеть, к которой они должны быть подключены (аналогично подключению NetBSD к сети VMnet). При этом машина FreeBSD будет иметь три активированных сетевых адаптера (рисунок 7), и каждый из них будет взаимодействовать со своей виртуальной сетью.

Для организации DHCP в сети VMnet2, к сожалению, нет GUI-инструмента, но эта задача решается через командную строку:

\begin{Verbatim}[frame=single]
VBoxManage dhcpserver add --netname VMnet2 --ip 192.168.40.1 \
   --netmask 255.255.255.0 --lowerip 192.168.40.32 --enable
\end{Verbatim}

Удалить этот DHCP-сервер можно командой

\begin{Verbatim}[frame=single]
VBoxManage dhcpserver remove --netname VMnet2
\end{Verbatim}

\begin{figure}[h!]
\centering
\includegraphics[scale=0.6]{res/freebsd-3net}
\caption{Три сетевые интерфейса, подключенные к разным сетям, на машине FreeBSD.}
\end{figure}

Как можно видеть выше, настройка выделенной виртуальной сети очень проста, для этого нужно только указать её имя. Эта простота компенсируется большей сложностью при создании и удалении DHCP-сервера для этой сети. Возможно в будущих версиях VirtualBox появятся более удобные инструменты для этого.

\end{document}